name: release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  generate-version:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.calver.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate CalVer
        id: calver
        run: |
          year=$(date +'%Y')
          month=$(date +'%-m')
          
          current_date="${year}.${month}"
          echo "Current date: ${current_date}"
          
          echo $(git tag -l "${current_date}.*")
          release_count=$(git tag | grep "^v${current_date}\." | wc -l)
          echo "Release count: ${release_count}"
          
          next_release=$((release_count + 1))
          echo "Next release: ${next_release}"
          
          version="${current_date}.${next_release}"
          echo "version=${version}" >> $GITHUB_OUTPUT
          echo "Generated version: ${version}"

  build-main-package:
    needs: generate-version
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup
        uses: ./.github/actions/setup
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set main field for build
        run: node scripts/set-main-for-build.js

      - name: Build package
        run: npm run build

      - name: Update or add version to package.json
        run: |
          if jq -e '.version' package.json > /dev/null 2>&1; then
            # Update existing version
            jq --arg version "${{ needs.generate-version.outputs.version }}" '.version = $version' package.json > package.json.tmp
          else
            # Add version field if it doesn't exist
            jq --arg version "${{ needs.generate-version.outputs.version }}" '. + {version: $version}' package.json > package.json.tmp
          fi
          mv package.json.tmp package.json
          cat package.json

      - name: Publish package
        run: |
          if ! npm publish --no-git-checks; then
            echo "Failed to publish package"
            exit 1
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_CONFIG_REGISTRY: "https://npm.pkg.github.com"

  create-release:
    needs: [generate-version, build-main-package]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push Git tag
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if ! git tag -a v${{ needs.generate-version.outputs.version }} -m "Release ${{ needs.generate-version.outputs.version }}"; then
            echo "Failed to create tag"
            exit 1
          fi
          
          if ! git push origin v${{ needs.generate-version.outputs.version }}; then
            echo "Failed to push tag"
            exit 1
          fi
